package org.gravel.support.parser;

/*
	This file is automatically generated. See FX.TService.TService class>>generateWorkspaces
	(C) CosmoCows B.V.
*/

import java.math.BigDecimal;
import java.math.BigInteger;
import org.gravel.support.jvm.NonLocalReturn;
import java.util.List;
import org.gravel.support.parser.PackageNode;
import org.gravel.support.parser.SystemNode;
import java.util.Map;
import org.gravel.support.parser.Reference;
import org.gravel.support.parser.ClassNode;
import org.gravel.support.parser.ClassDescriptionNode;
import org.gravel.support.parser.NamespaceNode;
import java.util.HashMap;
import org.gravel.support.parser.AbsoluteReference;

public class SystemNodeBuilder extends Object implements Cloneable {

	public static SystemNodeBuilder_Factory factory = new SystemNodeBuilder_Factory();

	List<PackageNode> _packages;

	public static class SystemNodeBuilder_Factory extends org.gravel.support.jvm.SmalltalkFactory {

		public SystemNodeBuilder basicNew() {
			SystemNodeBuilder newInstance = new SystemNodeBuilder();
			newInstance.initialize();
			return newInstance;
		}

		public SystemNodeBuilder packages_(final List<PackageNode> _anOrderedCollection) {
			return ((SystemNodeBuilder) this.basicNew().initializePackages_(_anOrderedCollection));
		}
	}

	static public SystemNodeBuilder _packages_(Object receiver, final List<PackageNode> _anOrderedCollection) {
		return factory.packages_(_anOrderedCollection);
	}

	public SystemNodeBuilder copy() {
		try {
			SystemNodeBuilder _temp1 = (SystemNodeBuilder) this.clone();
			_temp1.postCopy();
			return _temp1;
		} catch (CloneNotSupportedException e) {
			throw new RuntimeException(e);
		}
	}

	public SystemNodeBuilder_Factory factory() {
		return factory;
	}

	public SystemNodeBuilder initialize() {
		return this;
	}

	public SystemNodeBuilder initializePackages_(final List<PackageNode> _anOrderedCollection) {
		_packages = _anOrderedCollection;
		this.initialize();
		return this;
	}

	public SystemNode load() {
		final Map<Reference, ClassNode> _classNodes;
		final Map<Reference, ClassDescriptionNode> _classDescriptionNodes;
		final Map<Reference, NamespaceNode> _namespaceNodes;
		_classNodes = new java.util.HashMap<Reference, ClassNode>();
		_namespaceNodes = new java.util.HashMap<Reference, NamespaceNode>();
		this.packageClassNodesDo_(new org.gravel.support.jvm.Block1<Object, ClassNode>() {

			@Override
			public Object value_(final ClassNode _classNode) {
				if (!_classNode.isExtension()) {
					final Reference _reference;
					_reference = _classNode.reference();
					if (_classNodes.containsKey(_reference)) {
						throw new RuntimeException("Class " + _reference.toString() + " defined twice");
					}
					return _classNodes.put(_reference, _classNode);
				}
				return SystemNodeBuilder.this;
			}
		});
		this.packageClassNodesDo_(new org.gravel.support.jvm.Block1<Object, ClassNode>() {

			@Override
			public Object value_(final ClassNode _classNode) {
				if (_classNode.isExtension()) {
					final Reference _reference;
					_reference = _classNode.reference();
					if (!_classNodes.containsKey(_reference)) {
						throw new RuntimeException("Can\'t extend Class " + _reference.toString() + "; not defined yet");
					}
					return _classNodes.put(_reference, _classNodes.get(_reference).mergedWithExtension_(_classNode));
				}
				return SystemNodeBuilder.this;
			}
		});
		_classDescriptionNodes = new java.util.HashMap<Reference, ClassDescriptionNode>();
		for (final ClassNode _classNode : _classNodes.values()) {
			_classDescriptionNodes.put(_classNode.reference(), _classNode);
			_classDescriptionNodes.put(_classNode.metaclassNode().reference(), _classNode.metaclassNode());
		}
		this.packageNamespaceNodesDo_(new org.gravel.support.jvm.Block1<Object, NamespaceNode>() {

			@Override
			public Object value_(final NamespaceNode _namespaceNode) {
				final Reference _reference;
				_reference = _namespaceNode.reference();
				if (_namespaceNodes.containsKey(_reference)) {
					throw new RuntimeException("todo: merging");
				}
				return _namespaceNodes.put(_reference, _namespaceNode);
			}
		});
		for (final Reference _ref : _classNodes.keySet()) {
			final AbsoluteReference _namespace;
			_namespace = _ref.namespace();
			NamespaceNode _temp1 = _namespaceNodes.get(_namespace);
			if (_temp1 == null) {
				NamespaceNode _temp2 = NamespaceNode.factory.for_(_namespace);
				_namespaceNodes.put(_namespace, _temp2);
				_temp1 = _temp2;
			}
		}
		return SystemNode.factory.classDescriptionNodes_namespaceNodes_(_classDescriptionNodes, _namespaceNodes).flattenTraits();
	}

	public SystemNodeBuilder packageClassNodesDo_(final org.gravel.support.jvm.Block1<Object, ClassNode> _aBlock) {
		for (final PackageNode _packageNode : _packages) {
			for (final ClassNode _temp1 : _packageNode.classes()) {
				_aBlock.value_(_temp1);
			}
		}
		return this;
	}

	public SystemNodeBuilder packageNamespaceNodesDo_(final org.gravel.support.jvm.Block1<Object, NamespaceNode> _aBlock) {
		for (final PackageNode _packageNode : _packages) {
			for (final NamespaceNode _temp1 : _packageNode.namespaces()) {
				_aBlock.value_(_temp1);
			}
		}
		return this;
	}

	public List<PackageNode> packages() {
		return _packages;
	}

	public SystemNodeBuilder postCopy() {
		return this;
	}
}
